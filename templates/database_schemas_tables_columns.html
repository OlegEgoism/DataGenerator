{% extends 'base.html' %}
{% load static %}

{% block title %}Колонки таблицы {{ schema_name }}.{{ table_name }}{% endblock %}

{% block content %}

    {% if error_message %}
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle-fill"></i> {{ error_message }}
        </div>
    {% endif %}

    <h2 class="text-center mb-4">Таблица: {{ schema_name }}.{{ table_name }}</h2>

    <div class="card shadow-lg border-0 mx-auto panel-input">
        <div class="card-body text-top">
            <h5 class="card-title d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-2">
                    <img class="db-image" src="{{ project.data_base_name.images_db.url }}" alt="{{ project.data_base_name.name }}">
                    <span>{{ project.data_base_name }}</span>
                </div>
            </h5>
            <hr>

            <h5><strong>Проект:</strong> {{ project.db_project }}</h5>
            <h5><strong>База данных:</strong> {{ project.db_name }}</h5>
            <h5><strong>Схема:</strong> {{ schema_name }}</h5>
            <h5><strong>Таблица:</strong> {{ table_name }}</h5>
            <h5><strong>Количество записей:</strong> {{ record_count }} шт.</h5>

            <h5 class="mt-3"><strong>Колонки:</strong></h5>

            {% if error_message %}
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle-fill"></i> {{ error_message }}
                </div>
            {% else %}
                {% if columns %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th>#</th>
                                    <th>Название</th>
                                    <th>Тип</th>
                                    <th>Комментарий</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for column in columns %}
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td>{{ column.0 }}</td>
                                        <td>{{ column.1 }}</td>
                                        <td>
                                            {% if column.2 %}
                                                {{ column.2 }}
                                            {% else %}
                                                <span class="text-muted">—</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-warning text-center">
                        Колонки не найдены.
                    </div>
                {% endif %}
            {% endif %}

            <div class="d-flex justify-content-between align-items-center mt-3 flex-wrap gap-2">
                <!-- Назад -->
                <a href="{% url 'database_schemas_tables' project.pk schema_name %}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Назад
                </a>

                <div class="d-flex gap-2">
                    <!-- Добавить поля -->
                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addColumnsModal">
                        <i class="bi bi-plus-lg"></i> Добавить поля
                    </button>

{#                    <!-- Очистить таблицу -->#}
{#                    <form method="post" onsubmit="return confirm('Вы уверены, что хотите удалить все данные из таблицы?');">#}
{#                        {% csrf_token %}#}
{#                        <button type="submit" name="clear_table" class="btn btn-danger">#}
{#                            <i class="bi bi-trash"></i> Очистить таблицу#}
{#                        </button>#}
{#                    </form>#}
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Добавить поля -->
    <div class="modal fade" id="addColumnsModal" tabindex="-1" aria-labelledby="addColumnsLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <form method="post" action="{% url 'database_schemas_table_add_columns' project.pk schema_name table_name %}">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="addColumnsLabel">Добавить поля в {{ schema_name }}.{{ table_name }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
                    </div>
                    <div class="modal-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">Список новых столбцов</h6>
                            <button type="button" class="btn btn-outline-primary btn-sm" id="addColumnRow">
                                <i class="bi bi-plus-lg"></i> Добавить строку
                            </button>
                        </div>

                        <div id="newColumnsWrap" class="d-grid gap-2">
                            <!-- строки добавляются скриптом -->
                        </div>

                        <div class="form-text mt-2">
                            Поддерживаемые типы: INTEGER, VARCHAR(255), BOOLEAN, FLOAT, DATE.
                            Для комментария будет выполнен <code>COMMENT ON COLUMN</code>.
                            Для уникальности — <code>UNIQUE</code> при добавлении столбца.
                        </div>

                        <input type="hidden" name="next" value="{{ request.get_full_path }}">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-check2-circle"></i> Добавить столбцы
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
    (function() {
        let idx = 0;
        const wrap = document.getElementById('newColumnsWrap');
        const addBtn = document.getElementById('addColumnRow');

        function rowTemplate(i) {
            return `
            <div class="row g-2 align-items-end border rounded p-2 column-new-row">
                <input type="hidden" name="row_indices[]" value="${i}">
                <div class="col-md-4">
                  <label class="form-label mb-1"><strong>Имя столбца</strong></label>
                  <input type="text" class="form-control"
                         name="col_name_${i}" required
                         pattern="^[a-zA-Z_][a-zA-Z0-9_]*$" maxlength="63"
                         placeholder="column_name">
                </div>
                <div class="col-md-3">
                  <label class="form-label mb-1"><strong>Тип</strong></label>
                  <select class="form-select" name="col_type_${i}">
                    <option value="INTEGER">INTEGER</option>
                    <option value="VARCHAR(255)">VARCHAR(255)</option>
                    <option value="BOOLEAN">BOOLEAN</option>
                    <option value="FLOAT">FLOAT</option>
                    <option value="DATE">DATE</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label mb-1"><strong>Комментарий</strong></label>
                  <input type="text" class="form-control"
                         name="col_comment_${i}" placeholder="описание столбца">
                </div>
                <div class="col-md-1">
                  <label class="form-label mb-1"><strong>Уник.</strong></label>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="col_unique_${i}">
                  </div>
                </div>
                <div class="col-12 text-end">
                  <button type="button" class="btn btn-outline-danger btn-sm remove-col-row">
                    <i class="bi bi-x-lg"></i>
                  </button>
                </div>
            </div>`;
        }

        function addRow(prefill={}) {
            const i = idx++;
            const div = document.createElement('div');
            div.innerHTML = rowTemplate(i);
            const row = div.firstElementChild;

            if (prefill.name) row.querySelector(`[name="col_name_${i}"]`).value = prefill.name;
            if (prefill.type) row.querySelector(`[name="col_type_${i}"]`).value = prefill.type;
            if (prefill.comment) row.querySelector(`[name="col_comment_${i}"]`).value = prefill.comment;
            if (prefill.unique) row.querySelector(`[name="col_unique_${i}"]`).checked = !!prefill.unique;

            row.querySelector('.remove-col-row').addEventListener('click', () => row.remove());
            wrap.appendChild(row);
        }

        addBtn.addEventListener('click', () => addRow());

        // По умолчанию — одна строка
        addRow();
    })();
    </script>
{% endblock %}
