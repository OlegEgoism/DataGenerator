{% extends 'base.html' %}
{% load static %}

{% block title %}Колонки таблицы {{ schema_name }}.{{ table_name }}{% endblock %}

{% block content %}

  {% if error_message %}
    <div class="alert alert-danger">
      <i class="bi bi-exclamation-triangle-fill"></i> {{ error_message }}
    </div>
  {% endif %}

  <h2 class="text-center mb-4">Таблица: {{ table_name }}</h2>

  <div class="card shadow-lg border-0 mx-auto panel-projects">
    <div class="card-body text-top">
      <h5 class="card-title d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-2">
          <img class="db-image" src="{{ project.data_base_name.images_db.url }}" alt="{{ project.data_base_name.name }}">
          <span>{{ project.data_base_name }}</span>
        </div>
      </h5>
      <hr>

      <h5><strong>Проект:</strong> {{ project.db_project }}</h5>
      <h5><strong>База данных:</strong> {{ project.db_name }}</h5>
      <h5><strong>Схема:</strong> {{ schema_name }}</h5>
      <h5><strong>Размер БД:</strong> {{ db_size_pretty }}</h5>

      <!-- Поиск по колонкам -->
      <div class="d-flex flex-wrap align-items-center gap-2 mb-2 mt-2">
        <form method="get" class="d-flex gap-2 flex-grow-1">
          <input type="text"
                 name="search"
                 id="searchInput"
                 class="form-control"
                 placeholder="Поиск по колонкам (название, тип, комментарий)"
                 value="{{ request.GET.search }}">
          <button type="button" id="clearSearch" class="btn btn-outline-secondary">
            <i class="bi bi-x-circle"></i>
          </button>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-search"></i>
          </button>
        </form>
      </div>

      <h5><strong>Колонки:</strong></h5>

      {% if not error_message %}
        {% if columns %}
          <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
              <thead class="table-dark">
                <tr>
                  <th>#</th>
                  <th>Название</th>
                  <th>Тип</th>
                  <th>Комментарий</th>
                  <th class="text-end">Действия</th>
                </tr>
              </thead>
              <tbody>
                {% for column in columns %}
                  <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ column.0 }}</td>
                    <td>{{ column.1 }}</td>
                    <td>
                      {% if column.2 %}
                        {{ column.2 }}
                      {% else %}
                        <span class="text-muted">—</span>
                      {% endif %}
                    </td>
                    <td class="text-end">
                      <a href="#"
                         class="btn btn-success"
                         data-bs-toggle="modal"
                         data-bs-target="#renameColModal-{{ forloop.counter }}">
                        <i class="bi bi-pencil-square"></i> Переименовать
                      </a>
                      <button type="button"
                              class="btn btn-danger"
                              data-bs-toggle="modal"
                              data-bs-target="#deleteColModal-{{ forloop.counter }}">
                        <i class="bi bi-trash3"></i> Удалить
                      </button>
                    </td>
                  </tr>

                  <!-- MODAL: Переименовать колонку -->
                  <div class="modal fade" id="renameColModal-{{ forloop.counter }}" tabindex="-1"
                       aria-labelledby="renameColLabel-{{ forloop.counter }}" aria-hidden="true">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <div class="modal-header border-0 pb-0">
                          <h5 class="modal-title" id="renameColLabel-{{ forloop.counter }}">
                            Переименовать колонку: {{ column.0 }}
                          </h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
                        </div>
                        <form method="post"
                              action="{% url 'database_schemas_column_edit' project.pk schema_name table_name column.0 %}">
                          {% csrf_token %}
                          <div class="modal-body">
                            <div class="row mb-2 align-items-center">
                              <label for="newColName-{{ forloop.counter }}" class="col-sm-4 col-form-label text-end">
                                <strong>Новое имя:</strong>
                              </label>
                              <div class="col-sm-8">
                                <input type="text"
                                       class="form-control"
                                       id="newColName-{{ forloop.counter }}"
                                       name="new_column_name"
                                       value="{{ column.0 }}"
                                       required
                                       pattern="^[a-zA-Z_][a-zA-Z0-9_]*$"
                                       maxlength="63">
                              </div>
                            </div>
                            <input type="hidden" name="next" value="{{ request.get_full_path }}">
                          </div>
                          <div class="modal-footer border-0 pt-0">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                            <button type="submit" class="btn btn-primary">
                              <i class="bi bi-check2"></i> Переименовать
                            </button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>

                  <!-- MODAL: Удалить колонку -->
                  <div class="modal fade" id="deleteColModal-{{ forloop.counter }}" tabindex="-1"
                       aria-labelledby="deleteColLabel-{{ forloop.counter }}" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                      <div class="modal-content">
                        <div class="modal-header border-0 pb-0">
                          <h5 class="modal-title" id="deleteColLabel-{{ forloop.counter }}">
                            Удалить колонку?
                          </h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
                        </div>
                        <div class="modal-body">
                          Вы действительно хотите удалить колонку
                          <strong>«{{ schema_name }}.{{ table_name }}.{{ column.0 }}»</strong>?<br>
                          Это действие <strong>необратимо</strong>.
                        </div>
                        <div class="modal-footer border-0 pt-0">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                          <form method="post"
                                action="{% url 'database_schemas_column_delete' project.pk schema_name table_name column.0 %}">
                            {% csrf_token %}
                            <input type="hidden" name="next" value="{{ request.get_full_path }}">
                            <button type="submit" class="btn btn-danger">
                              <i class="bi bi-trash3"></i> Удалить
                            </button>
                          </form>
                        </div>
                      </div>
                    </div>
                  </div>

                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="alert alert-warning text-center">
            {% if request.GET.search %}
              По запросу <strong>"{{ request.GET.search }}"</strong> ничего не найдено.
            {% else %}
              Колонки не найдены.
            {% endif %}
          </div>
        {% endif %}
      {% endif %}

      <!-- Кнопки действий -->
      <div class="d-flex justify-content-between align-items-center mt-3 flex-wrap gap-2">
        <a href="{% url 'database_schemas_tables' project.pk schema_name %}" class="btn btn-secondary">
          <i class="bi bi-arrow-left"></i> Назад
        </a>
        <div class="d-flex gap-2">
          <a href="{% url 'database_schemas_table_data' project.pk schema_name table_name %}" class="btn btn-success">
            <i class="bi bi-table"></i> Данные в таблице
          </a>
          <a href="{% url 'generate_fake_data' project.pk schema_name table_name %}" class="btn btn-success">
            <i class="bi bi-arrow-repeat"></i> Сгенерировать данные
          </a>
          <a href="{% url 'database_schemas_table_add_columns' project.pk schema_name table_name %}" class="btn btn-success">
            <i class="bi bi-plus-lg"></i> Добавить поля
          </a>
          <!-- Очистить таблицу -->
          <button type="button" class="btn btn-danger"
                  data-bs-toggle="modal" data-bs-target="#clearTableModal">
            <i class="bi bi-trash"></i> Очистить таблицу
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: Очистить таблицу -->
  <div class="modal fade" id="clearTableModal" tabindex="-1" aria-labelledby="clearTableLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title" id="clearTableLabel">Очистить таблицу?</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
        </div>
        <form method="post" action="{% url 'database_schemas_table_clear' project.pk schema_name table_name %}">
          {% csrf_token %}
          <div class="modal-body">
            <p class="mb-2">
              Вы действительно хотите <strong>полностью очистить</strong> таблицу
              <strong>«{{ schema_name }}.{{ table_name }}»</strong>?
            </p>
            <p class="mb-2">
              Все данные будут удалены. Это действие <strong>необратимо</strong>.
            </p>
            <div class="form-check mt-2">
              <input class="form-check-input" type="checkbox" id="restartIdentity" name="restart_identity">
              <label class="form-check-label" for="restartIdentity">
                Сбросить автоинкремент (RESTART IDENTITY)
              </label>
            </div>
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
          </div>
          <div class="modal-footer border-0 pt-0">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
            <button type="submit" class="btn btn-danger">
              <i class="bi bi-trash"></i> Очистить
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- общий скрипт очистки поля поиска -->
  <script src="{% static 'js/search.js' %}"></script>
{% endblock %}
